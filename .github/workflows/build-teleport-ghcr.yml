name: Build Teleport images on Hetzner runner and push to GHCR

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (tag/branch/SHA). Empty = current ref."
        required: false
        default: ""
      version_tag:
        description: "Image tag to publish (e.g., 18.6.4). Empty = derive from git tag or SHA."
        required: false
        default: ""
      push:
        description: "Push images to GHCR (true/false)"
        required: true
        default: "false"
      server_type:
        description: "Hetzner server type (e.g., cpx42, ccx33)."
        required: true
        default: "cpx42"
      location:
        description: "Hetzner location (e.g., fsn1, nbg1)."
        required: true
        default: "fsn1"
      image:
        description: "Hetzner OS image (e.g., ubuntu-24.04, rocky-9)."
        required: true
        default: "ubuntu-24.04"
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

env:
  GHCR_OWNER: ${{ github.repository_owner }}

  REPO_TELEPORT_DISTROLESS: teleport-distroless
  REPO_TELEPORT_DISTROLESS_DEBUG: teleport-distroless-debug
  REPO_TBOT_DISTROLESS: tbot-distroless

  # Buildbox containers mount /tmp:/tmp. Keep all caches under /tmp to avoid HOME/GOMODCACHE issues.
  HOME: /tmp
  GOPATH: /tmp/go
  GOMODCACHE: /tmp/gomodcache
  GOCACHE: /tmp/go-build-cache
  XDG_CACHE_HOME: /tmp/.cache

jobs:
  create-runner:
    name: Create Hetzner Cloud runner
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.create.outputs.label }}
      server_id: ${{ steps.create.outputs.server_id }}
    steps:
      - name: Create runner
        id: create
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: create
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}

          # Sizing/location/OS
          server_type: ${{ inputs.server_type }}
          location: ${{ inputs.location }}
          image: ${{ inputs.image }}

          # Optional (recommended): provide SSH key ID to avoid root password mail.
          # ssh_key: ${{ secrets.HCLOUD_SSH_KEY_ID }}

          # Pre-runner bootstrap: install Docker + basic toolchain needed by Teleport build targets
          pre_runner_script: |
            set -euo pipefail

            echo "=== OS info ==="
            cat /etc/os-release || true
            uname -a || true

            echo "=== Installing base dependencies (git, make, docker) ==="
            if command -v apt-get >/dev/null 2>&1; then
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -y
              # build-essential ensures make + toolchain basics
              apt-get install -y --no-install-recommends \
                ca-certificates curl git jq \
                build-essential \
                docker.io docker-buildx-plugin docker-compose-plugin \
                coreutils util-linux
              systemctl enable --now docker
            elif command -v dnf >/dev/null 2>&1; then
              dnf install -y git make jq ca-certificates curl docker
              systemctl enable --now docker
              systemctl start docker
            elif command -v zypper >/dev/null 2>&1; then
              zypper --non-interactive refresh
              zypper --non-interactive install git make jq ca-certificates curl docker
              systemctl enable --now docker
              systemctl start docker
            else
              echo "ERROR: No supported package manager found (apt-get/dnf/zypper)."
              exit 1
            fi

            echo "=== Verifying tools ==="
            command -v make
            command -v git
            command -v docker

            docker version

            echo "=== /tmp setup ==="
            mkdir -p /tmp
            chmod 1777 /tmp


  build-and-push:
    name: Build Teleport images on Hetzner runner
    needs: create-runner
    runs-on: ${{ needs.create-runner.outputs.label }}

    steps:
      - name: Verify runner toolchain
        shell: bash
        run: |
          set -euo pipefail
          echo "Runner OS:"
          cat /etc/os-release || true
          echo "Tools:"
          command -v make
          command -v git
          command -v docker
          docker version
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Compute image tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ inputs.version_tag }}" ]]; then
            TAG="${{ inputs.version_tag }}"
          else
            REF_NAME="${GITHUB_REF_NAME:-}"
            if [[ "${REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              TAG="${REF_NAME#v}"
            else
              TAG="$(echo "${GITHUB_SHA}" | cut -c1-12)"
            fi
          fi

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Using image tag: ${TAG}"

      - name: Prepare writable cache dirs for buildbox containers
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache
          chmod -R 0777 /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache
          df -h

      - name: Build Teleport binaries (dockerized build)
        shell: bash
        env:
          HOME: /tmp
          GOPATH: /tmp/go
          GOMODCACHE: /tmp/gomodcache
          GOCACHE: /tmp/go-build-cache
          XDG_CACHE_HOME: /tmp/.cache
        run: |
          set -euo pipefail
          make -C build.assets build-binaries

      - name: Build Teleport Docker images
        shell: bash
        env:
          HOME: /tmp
          GOPATH: /tmp/go
          GOMODCACHE: /tmp/gomodcache
          GOCACHE: /tmp/go-build-cache
          XDG_CACHE_HOME: /tmp/.cache
        run: |
          set -euo pipefail
          make docker

      - name: Identify locally built images
        id: images
        shell: bash
        run: |
          set -euo pipefail

          echo "Local images:"
          docker images --format '  - {{.Repository}}:{{.Tag}}'

          find_image () {
            local suffix="$1"
            docker images --format '{{.Repository}}:{{.Tag}}' | grep -E "${suffix}(:|$)" | head -n1 || true
          }

          TELEPORT_DISTROLESS_LOCAL="$(find_image 'teleport-distroless')"
          TELEPORT_DISTROLESS_DEBUG_LOCAL="$(find_image 'teleport-distroless-debug')"
          TBOT_DISTROLESS_LOCAL="$(find_image 'tbot-distroless')"

          echo "teleport_distroless_local=${TELEPORT_DISTROLESS_LOCAL}" >> "$GITHUB_OUTPUT"
          echo "teleport_distroless_debug_local=${TELEPORT_DISTROLESS_DEBUG_LOCAL}" >> "$GITHUB_OUTPUT"
          echo "tbot_distroless_local=${TBOT_DISTROLESS_LOCAL}" >> "$GITHUB_OUTPUT"

          if [[ -z "${TELEPORT_DISTROLESS_LOCAL}" ]]; then
            echo "ERROR: Could not locate a locally built teleport-distroless image."
            exit 1
          fi

      - name: Log in to GHCR (only when pushing)
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Tag images for GHCR
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"

          T1="ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS}:${TAG}"
          T2="ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS_DEBUG}:${TAG}"
          T3="ghcr.io/${GHCR_OWNER}/${REPO_TBOT_DISTROLESS}:${TAG}"

          echo "Tagging ${T1}"
          docker tag "${{ steps.images.outputs.teleport_distroless_local }}" "${T1}"

          if [[ -n "${{ steps.images.outputs.teleport_distroless_debug_local }}" ]]; then
            echo "Tagging ${T2}"
            docker tag "${{ steps.images.outputs.teleport_distroless_debug_local }}" "${T2}"
          else
            echo "WARN: teleport-distroless-debug local image not found; skipping."
          fi

          if [[ -n "${{ steps.images.outputs.tbot_distroless_local }}" ]]; then
            echo "Tagging ${T3}"
            docker tag "${{ steps.images.outputs.tbot_distroless_local }}" "${T3}"
          else
            echo "WARN: tbot-distroless local image not found; skipping."
          fi

      - name: Push images to GHCR
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"

          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS}:${TAG}"
          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS_DEBUG}:${TAG}" || true
          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TBOT_DISTROLESS}:${TAG}" || true

      - name: Summary
        shell: bash
        run: |
          echo "Built tag: ${{ steps.vars.outputs.tag }}"
          echo "Pushed: ${{ inputs.push }} (or tag build push on v*)"

  delete-runner:
    name: Delete Hetzner Cloud runner
    needs:
      - create-runner
      - build-and-push
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Delete runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: delete
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          name: ${{ needs.create-runner.outputs.label }}
          server_id: ${{ needs.create-runner.outputs.server_id }}
