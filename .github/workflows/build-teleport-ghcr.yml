name: Build Teleport images on Hetzner runner and push to GHCR

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (tag/branch/SHA). Empty = current ref."
        required: false
        default: ""
      version_tag:
        description: "Image tag to publish (e.g., 18.6.4). Empty = derive from git tag or SHA."
        required: false
        default: ""
      push:
        description: "Push images to GHCR (true/false)"
        required: true
        default: "false"
      server_type:
        description: "Hetzner server type (e.g., cpx42, ccx33)."
        required: true
        default: "cpx42"
      location:
        description: "Hetzner location (e.g., fsn1, nbg1)."
        required: true
        default: "fsn1"
      image:
        description: "Hetzner OS image (Ubuntu only, e.g., ubuntu-24.04)."
        required: true
        default: "ubuntu-24.04"
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

env:
  GHCR_OWNER: ${{ github.repository_owner }}

  REPO_TELEPORT_DISTROLESS: teleport-distroless
  REPO_TELEPORT_DISTROLESS_DEBUG: teleport-distroless-debug
  REPO_TBOT_DISTROLESS: tbot-distroless

  HOME: /tmp
  GOPATH: /tmp/go
  GOMODCACHE: /tmp/gomodcache
  GOCACHE: /tmp/go-build-cache
  XDG_CACHE_HOME: /tmp/.cache

jobs:
  create-runner:
    name: Create Hetzner Cloud runner
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.create.outputs.label }}
      server_id: ${{ steps.create.outputs.server_id }}
    steps:
      - name: Create runner
        id: create
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: create
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          server_type: ${{ inputs.server_type }}
          location: ${{ inputs.location }}
          image: ${{ inputs.image }}
          pre_runner_script: |
            set -euo pipefail
            mkdir -p /tmp
            chmod 1777 /tmp

  build-and-push:
    name: Build Teleport images on Hetzner runner
    needs: create-runner
    runs-on: ${{ needs.create-runner.outputs.label }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Normalize go directive in all go.mod files (X.Y.Z -> X.Y)
        shell: bash
        run: |
          set -euo pipefail
          echo "go.mod before:"
          sed -n '1,6p' go.mod || true

          while IFS= read -r -d '' f; do
            perl -0777 -pe 's/^(go\s+\d+\.\d+)\.\d+(\s*)$/$1$2/m' -i "$f"
          done < <(find . -name go.mod -print0)

          echo "go.mod after:"
          sed -n '1,6p' go.mod || true

      - name: Fix workspace permissions for UID 1000 (required for webassets)
        shell: bash
        run: |
          set -euo pipefail
          sudo chown -R 1000:1000 "$GITHUB_WORKSPACE"
          sudo chmod -R u+rwX,g+rwX "$GITHUB_WORKSPACE"

      - name: Set up Go (host)
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Install ALL host dependencies (Ubuntu only)
        shell: bash
        run: |
          set -euo pipefail

          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl gnupg lsb-release \
            git jq \
            build-essential pkg-config \
            rsync unzip tar xz-utils

          # Docker official repo (ensures docker-buildx-plugin + docker-compose-plugin exist)
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg

          UBUNTU_CODENAME="$(. /etc/os-release && echo "${VERSION_CODENAME}")"
          ARCH="$(dpkg --print-architecture)"
          echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${UBUNTU_CODENAME} stable" \
            | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            docker-ce docker-ce-cli containerd.io \
            docker-buildx-plugin docker-compose-plugin

          sudo systemctl enable --now docker
          sudo chmod 666 /var/run/docker.sock

          echo "Verify toolchain:"
          go version
          make --version
          docker version
          docker buildx version
          docker compose version || true
          df -h

      - name: Prepare writable cache dirs (/tmp)
        shell: bash
        run: |
          set -euo pipefail
          # Must be writable for the buildbox containers running as -u 1000:1000
          sudo mkdir -p /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache
          sudo chown -R 1000:1000 /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache
          sudo chmod -R 0777 /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache
          ls -ld /tmp /tmp/gomodcache /tmp/go-build-cache /tmp/go /tmp/.cache

      - name: Compute build UID/GID (force non-root)
        id: ug
        shell: bash
        run: |
          set -euo pipefail
          echo "build_uid=1000" >> "$GITHUB_OUTPUT"
          echo "build_gid=1000" >> "$GITHUB_OUTPUT"
          echo "Using BUILD_UID=1000 BUILD_GID=1000"

      - name: Compute image tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ inputs.version_tag }}" ]]; then
            TAG="${{ inputs.version_tag }}"
          else
            REF_NAME="${GITHUB_REF_NAME:-}"
            if [[ "${REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              TAG="${REF_NAME#v}"
            else
              TAG="$(echo "${GITHUB_SHA}" | cut -c1-12)"
            fi
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Using image tag: ${TAG}"

      - name: Build buildbox images locally (NO pulls, robust targets)
        shell: bash
        env:
          HOME: /tmp
          GOPATH: /tmp/go
          GOMODCACHE: /tmp/gomodcache
          GOCACHE: /tmp/go-build-cache
          XDG_CACHE_HOME: /tmp/.cache
        run: |
          set -euo pipefail

          BUILD_UID="${{ steps.ug.outputs.build_uid }}"
          BUILD_GID="${{ steps.ug.outputs.build_gid }}"
          NODE_VERSION_DEFAULT="20"

          echo "=== build.assets dir ==="
          ls -la build.assets

          echo "=== Available make targets (filtered) ==="
          make -C build.assets -qp 2>/dev/null | awk -F: '/^[a-zA-Z0-9_.-]+:([^=]|$)/{print $1}' | sort -u | \
            egrep -i 'build(box)?-(node|centos7|assets)|centos7.*assets|assets.*centos7' || true

          echo "=== Build buildbox-node ==="
          make -C build.assets \
            UID="${BUILD_UID}" GID="${BUILD_GID}" \
            NODE_VERSION="${NODE_VERSION_DEFAULT}" \
            buildbox-node

          echo "=== Build CentOS7 assets image (target detection or docker build) ==="
          ASSETS_IMAGE="teleport-buildbox-centos7-assets:local"

          if make -C build.assets -n buildbox-centos7-assets >/dev/null 2>&1; then
            echo "Using make target: buildbox-centos7-assets"
            make -C build.assets UID="${BUILD_UID}" GID="${BUILD_GID}" buildbox-centos7-assets
            ASSETS_IMAGE=""
          elif make -C build.assets -n build-centos7-assets >/dev/null 2>&1; then
            echo "Using make target: build-centos7-assets"
            make -C build.assets UID="${BUILD_UID}" GID="${BUILD_GID}" build-centos7-assets
            ASSETS_IMAGE=""
          else
            echo "No make target for centos7 assets found. Building via docker buildx."
            if [[ -f build.assets/Dockerfile-centos7-assets ]]; then
              DF="Dockerfile-centos7-assets"
            elif [[ -f build.assets/Dockerfile-centos7-assets-image ]]; then
              DF="Dockerfile-centos7-assets-image"
            elif [[ -f build.assets/Dockerfile-centos7-assets.dockerfile ]]; then
              DF="Dockerfile-centos7-assets.dockerfile"
            else
              echo "ERROR: Could not find a Dockerfile for centos7 assets in build.assets/"
              echo "Files:"
              ls -la build.assets
              exit 1
            fi

            docker buildx build \
              --load \
              -f "build.assets/${DF}" \
              -t "${ASSETS_IMAGE}" \
              build.assets
          fi

          echo "=== Build buildbox-centos7 ==="
          if [[ -n "${ASSETS_IMAGE}" ]]; then
            echo "Using BUILDBOX_CENTOS7_ASSETS=${ASSETS_IMAGE}"
            make -C build.assets \
              UID="${BUILD_UID}" GID="${BUILD_GID}" \
              BUILDBOX_CENTOS7_ASSETS="${ASSETS_IMAGE}" \
              buildbox-centos7
          else
            make -C build.assets \
              UID="${BUILD_UID}" GID="${BUILD_GID}" \
              buildbox-centos7
          fi

      - name: Build Teleport binaries (dockerized build)
        shell: bash
        env:
          HOME: /tmp
          GOPATH: /tmp/go
          GOMODCACHE: /tmp/gomodcache
          GOCACHE: /tmp/go-build-cache
          XDG_CACHE_HOME: /tmp/.cache
        run: |
          set -euo pipefail
          BUILD_UID="${{ steps.ug.outputs.build_uid }}"
          BUILD_GID="${{ steps.ug.outputs.build_gid }}"
          make -C build.assets UID="${BUILD_UID}" GID="${BUILD_GID}" build-binaries

      - name: Build Teleport Docker images
        shell: bash
        env:
          HOME: /tmp
          GOPATH: /tmp/go
          GOMODCACHE: /tmp/gomodcache
          GOCACHE: /tmp/go-build-cache
          XDG_CACHE_HOME: /tmp/.cache
        run: |
          set -euo pipefail
          make docker

      - name: Identify locally built images
        id: images
        shell: bash
        run: |
          set -euo pipefail
          docker images --format '  - {{.Repository}}:{{.Tag}}'

          find_image () {
            local suffix="$1"
            docker images --format '{{.Repository}}:{{.Tag}}' | grep -E "${suffix}(:|$)" | head -n1 || true
          }

          TELEPORT_DISTROLESS_LOCAL="$(find_image 'teleport-distroless')"
          TELEPORT_DISTROLESS_DEBUG_LOCAL="$(find_image 'teleport-distroless-debug')"
          TBOT_DISTROLESS_LOCAL="$(find_image 'tbot-distroless')"

          echo "teleport_distroless_local=${TELEPORT_DISTROLESS_LOCAL}" >> "$GITHUB_OUTPUT"
          echo "teleport_distroless_debug_local=${TELEPORT_DISTROLESS_DEBUG_LOCAL}" >> "$GITHUB_OUTPUT"
          echo "tbot_distroless_local=${TBOT_DISTROLESS_LOCAL}" >> "$GITHUB_OUTPUT"

          if [[ -z "${TELEPORT_DISTROLESS_LOCAL}" ]]; then
            echo "ERROR: Could not locate a locally built teleport-distroless image."
            exit 1
          fi

      - name: Log in to GHCR (only when pushing)
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Tag images for GHCR
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"

          T1="ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS}:${TAG}"
          T2="ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS_DEBUG}:${TAG}"
          T3="ghcr.io/${GHCR_OWNER}/${REPO_TBOT_DISTROLESS}:${TAG}"

          docker tag "${{ steps.images.outputs.teleport_distroless_local }}" "${T1}"

          if [[ -n "${{ steps.images.outputs.teleport_distroless_debug_local }}" ]]; then
            docker tag "${{ steps.images.outputs.teleport_distroless_debug_local }}" "${T2}"
          else
            echo "WARN: teleport-distroless-debug local image not found; skipping."
          fi

          if [[ -n "${{ steps.images.outputs.tbot_distroless_local }}" ]]; then
            docker tag "${{ steps.images.outputs.tbot_distroless_local }}" "${T3}"
          else
            echo "WARN: tbot-distroless local image not found; skipping."
          fi

      - name: Push images to GHCR
        if: ${{ inputs.push == 'true' || startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"
          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS}:${TAG}"
          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TELEPORT_DISTROLESS_DEBUG}:${TAG}" || true
          docker push "ghcr.io/${GHCR_OWNER}/${REPO_TBOT_DISTROLESS}:${TAG}" || true

      - name: Summary
        shell: bash
        run: |
          echo "Built tag: ${{ steps.vars.outputs.tag }}"
          echo "Pushed: ${{ inputs.push }} (or tag build push on v*)"

  delete-runner:
    name: Delete Hetzner Cloud runner
    needs:
      - create-runner
      - build-and-push
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Delete runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: delete
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          name: ${{ needs.create-runner.outputs.label }}
          server_id: ${{ needs.create-runner.outputs.server_id }}
