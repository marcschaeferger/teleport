name: Build and Push Operator Image
run-name: Build Operator Image - ${{ github.run_id }} - @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      registry:
        description: 'Container registry (e.g., ghcr.io, docker.io)'
        required: true
        default: 'ghcr.io'
      image_name:
        description: 'Image name without registry (e.g., yourorg/teleport-operator)'
        required: true
        default: 'yourorg/teleport-operator'
      image_tag:
        description: 'Image tag (leave empty to use branch name or PR number)'
        required: false
        default: ''
      platforms:
        description: 'Target platforms (comma-separated)'
        required: true
        default: 'linux/amd64,linux/arm64'
      base_image:
        description: 'Base distroless image'
        required: true
        default: 'gcr.io/distroless/cc-debian12'
      push:
        description: 'Push to registry (true/false)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  #push:
  #  branches:
  #    - main
  #    - master
  #    - 'branch/*'
  #  paths:
  #    - 'integrations/operator/**'
  #    - 'api/**'
  #    - 'lib/**'
  #    - 'gen/**'
  #    - 'entitlements/**'
  #    - 'go.mod'
  #    - 'go.sum'
  #    - '.github/workflows/build-operator-image.yaml'

#  pull_request:
#    paths:
#      - 'integrations/operator/**'
#      - 'api/**'
#      - 'lib/**'
#      - 'gen/**'
#      - 'entitlements/**'
#      - 'go.mod'
#      - 'go.sum'
#      - '.github/workflows/build-operator-image.yaml'

env:
  REGISTRY: ${{ inputs.registry || 'ghcr.io' }}
  IMAGE_NAME: ${{ inputs.image_name || format('{0}/teleport-operator', github.repository_owner) }}
  BASE_IMAGE: ${{ inputs.base_image || 'gcr.io/distroless/cc-debian12' }}
  PLATFORMS: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}

jobs:
  build-and-push:
    name: Build and Push Operator Image
    runs-on: ubuntu-22.04

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Determine image tag
        id: meta
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            TAG="${{ inputs.image_tag }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TAG="pr-${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Use branch name, replace / with -
            TAG="${GITHUB_REF#refs/heads/}"
            TAG="${TAG//\//-}"
          else
            TAG="latest"
          fi
          
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Full image tag: ${REGISTRY}/${IMAGE_NAME}:${TAG}"

      - name: Log in to Container Registry
        if: ${{ inputs.push != 'false' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.meta.outputs.tag }}
            type=sha,prefix=sha-,format=short
            type=ref,event=pr,prefix=pr-

      - name: Build and push operator image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./integrations/operator/Dockerfile.gha
          platforms: ${{ env.PLATFORMS }}
          push: ${{ inputs.push != 'false' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Image details
        run: |
          echo "### Operator Image Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.meta.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** \`${{ env.PLATFORMS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Base Image:** \`${{ env.BASE_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Full Image Reference:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.push }}" = "false" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** Image was built but not pushed to registry." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test image (pull and inspect)
        if: ${{ inputs.push != 'false' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
        run: |
          # Pull the first platform to verify push was successful
          FIRST_PLATFORM=$(echo "${{ env.PLATFORMS }}" | cut -d',' -f1)
          docker pull --platform="${FIRST_PLATFORM}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}"
          docker inspect "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}"
