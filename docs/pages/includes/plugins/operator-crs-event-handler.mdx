{{ plugin="plugin" }}

If you have the Teleport Kubernetes Operator enabled on your Teleport cluster,
you can configure the `{{ plugin }}` Helm chart
to create RBAC resources and bootstrap the plugin with
Machine & Workload Identity. The resulting `tbot` deployment will then
issue and renew credentials for the `{{ plugin }}` to access Teleport.

See the [Teleport Kubernetes Operator guides](../../zero-trust-access/infrastructure-as-code/teleport-operator/teleport-operator.mdx)
for details on how to set up the Teleport Kubernetes Operator for your Teleport cluster.

Add the following to the configuration file `{{ plugin }}-values.yaml`,
according to your Teleport cluster. The `teleport` section should be removed.
Ensure `crd.namespace` is set to the namespace the Kubernetes Operator is running in.

```yaml
# values.yaml
crd:
  create: true
  namespace: ""
  tokenSpecOverride: {}

tbot:
  enabled: true
  clusterName: teleport.example.com
  teleportProxyAddress: teleport.example.com:443
  token: "{{ plugin }}-bot"
```

The `crd.create` field will tell the chart to create `TeleportRoleV8`, `TeleportBotV1`,
and `TeleportProvisionToken` custom resources. The Kubernetes Operator will watch
for these resources and update the corresponding resources in the Teleport cluster.
This will set up the Bot user with appropriate role permissions to access Teleport and
for the Machine & Identity bot, `tbot`, to authenticate as when connecting to the cluster.

The `tbot` section configures the `tbot` deployment that will issue
the credentials for the `{{ plugin }}` to access Teleport.
The value for `tbot.token` will determine the name of the created `TeleportProvisionToken` resource.
By default, `tbot` will write an `identity` file to a Kubernetes secret to `{{ plugin }}-tbot-out`.

#### Specifying a join method for tbot

By default, the chart configures the TeleportProvisionToken resource to the `kubernetes`
in_cluster join method.

Optionally, you can override the token specification for other join methods
using the `crd.tokenSpecOverride` field. For `kubernetes` join types,
the chart automatically sets the allow rule to the `tbot` deployment's service account.
For other join methods, you must specify `tokenSpecOverride.join_method` and the corresponding
join method configuration.

See [the join method reference](../../reference/deployment/join-methods.mdx) for a list of supported values and detailed explanations.

<details>
<summary>Example (Kubernetes JWKS join method)</summary>
You can override the TeleportProvisionToken specification to use the `kubernetes` JWKS join method.

```yaml
# values.yaml
tokenSpecOverride:
  join_method: kubernetes
  kubernetes:
    type: static_jwks
    static_jwks:
      jwks: |
        # Place the kubernetes JWKS here (`kubectl get --raw /openid/v1/jwks`)
        {"keys":[--snip--]}
```
</details>

<details>
<summary>Example (Kubernetes OIDC join method)</summary>
You can override the TeleportProvisionToken specification to use the `kubernetes` OIDC join method.

```yaml
# values.yaml
tokenSpecOverride:
  join_method: kubernetes
  kubernetes:
    type: oidc
    oidc:
      # Insert the OIDC issuer value here, it will vary depending on your
      # cluster and cloud provider.
      issuer: https://oidc.eks.us-west-2.amazonaws.com/id/my-cluster
```
</details>
